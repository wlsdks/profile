<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${board.title}">제목</title>
    <link rel="stylesheet" href="/css/board/detail.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1 th:text="${board.title}">제목</h1>
    </div>
    <div class="info">
        <div class="author-date">
            <span class="author"><strong>작성자:</strong> <span th:text="${board.userDto.username}">작성자</span></span>
            <span th:if="${board.createdAt != null}" th:text="${board.createdAt.format(T(java.time.format.DateTimeFormatter).ofPattern('yyyy-MM-dd'))}">날짜</span>
            <span th:unless="${board.createdAt != null}">날짜 없음</span>
        </div>
    </div>
    <div class="content">
        <strong>내용:</strong>
        <p th:text="${board.content}">내용</p>
    </div>
    <div class="likes-views">
        <span class="views"><strong>조회수:</strong> <span th:text="${board.views}">0</span></span>
        <div class="likes">
            <button onclick="likePost()">좋아요</button>
            <span th:text="${board.likes}">0</span>
        </div>
    </div>
    <div class="comment-section">
        <div class="comment-form">
            <textarea id="comment-input" placeholder="댓글을 작성하세요..."></textarea>
            <button onclick="addComment()">댓글 작성</button>
        </div>
        <div id="comment-list"></div>
        <div id="pagination"></div>
    </div>
    <div class="actions">
        <a href="/board/list" class="back-button">목록으로 돌아가기</a>
        <a th:href="@{/board/update/{boardId}(boardId=${boardId})}" class="edit-button" th:data-board-id="${boardId}">수정하기</a>
    </div>
</div>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // 페이지 로드가 완료되면 댓글을 불러옵니다.
    $(document).ready(function() {
        let boardId = $('.edit-button').data('board-id'); // boardId 가져오기
        getComments(boardId, currentPage); // 첫 페이지 댓글 불러오기
    });

    $('.edit-button').click(function (e) {
        e.preventDefault(); // 기본 링크 동작을 막습니다.
        let boardId = $(this).data('board-id'); // data-board-id 속성에서 boardId 가져오기
        let url = '/board/update/validUser?boardId=' + boardId; // 검증 URL에 boardId 포함

        // 사용자 검증 요청을 보냅니다.
        $.ajax({
            url: url,
            type: 'GET',
            success: function (response) {
                // 검증 성공 시 수정 페이지로 이동합니다.
                debugger
                window.location.href = '/board/update/' + boardId;
            },
            error: function (xhr, status, error) {
                // 검증 실패 시 에러 메시지를 표시합니다.
                alert('유저가 다릅니다. 수정할 수 없습니다.');
            }
        });
    });


    // 댓글 작성 함수
    function addComment() {
        let boardId = $('.edit-button').data('board-id');
        let content = $('#comment-input').val();
        $.ajax({
            url: '/board/comment/create/' + boardId, // 경로에 boardId 포함
            method: 'POST',
            contentType: 'application/json', // Content-Type 설정
            data: JSON.stringify({ content: content }), // JSON 형식으로 변환
            success: function() {
                getComments(boardId); // 댓글을 다시 불러옵니다.
                $('#comment-input').val(''); // 입력창을 비웁니다.
            }
        });
    }

    /** 댓글 페이징 로직 **/
    let currentPage = 1; // 현재 페이지 번호

    // 댓글을 받아와서 뿌려주는 로직
    function getComments(boardId, page) {
        $.ajax({
            url: '/board/comment/get/' + boardId,
            method: 'GET',
            data: { page: page - 1 }, // 페이지 번호는 0부터 시작하므로 -1
            success: function(response) {
                let comments = response.content; // 페이징된 댓글 내용
                let commentListHtml = '';
                comments.forEach(function(comment) {
                    commentListHtml += `<div class="comment">`;
                    commentListHtml += `<span class="author">${comment.userResponse.username}:</span> `;
                    commentListHtml += `${comment.content} `;
                    commentListHtml += `</div>`;
                });
                $('#comment-list').html(commentListHtml);

                // 페이징 처리
                let totalPages = response.totalPages; // 전체 페이지 수
                let paginationHtml = '';
                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += `<button onclick="getComments(${boardId}, ${i})">${i}</button>`;
                }
                $('#pagination').html(paginationHtml);
            }
        });
    }


    // 댓글 수정 함수
    function editComment(commentId) {
        // 댓글 수정 로직
    }

    // 댓글 삭제 함수
    function deleteComment(commentId) {
        // 댓글 삭제 로직
    }

    function likePost() {
        alert('좋아요를 눌렀습니다!');
        // 여기에 좋아요 기능을 처리하는 AJAX 코드를 추가할 수 있습니다.
    }

</script>
